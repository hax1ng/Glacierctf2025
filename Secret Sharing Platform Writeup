
The Challenge (498 points)

  We're given a web application called "Secret Sharing Platform" - think of it like a password manager where you can store TOTP codes (those 6-digit codes that change every 30 seconds, like
  Google Authenticator). The twist? There's a flag hidden in the admin's account, and we need to steal it.

  First Look

  Connecting to the challenge spawns a fresh instance. The app lets you:
  - Register an account
  - Store TOTP/HOTP secrets
  - Share secrets with others via temporary links
  - Export your secrets as JSON

  The admin has already registered and stored the flag as a TOTP secret. Our job? Get it.

  Finding the Bugs

  Bug #1: Homemade Randomness (Never a Good Idea)

  Digging through the source code, I found this gem:

  class TokenPRNG:
      def __init__(self, seed: bytes):
          self._key = bytes(seed)
          self._ctr = 0

      def _prf(self, nbytes: int) -> bytes:
          # Uses HMAC-SHA256 with an incrementing counter
          ...

  Instead of using Python's secure secrets module, they rolled their own "random" number generator. Even worse, the seed comes from:

  RUN echo "SSP_RNG_SEED='$(od -An -N4 -tu4 < /dev/urandom)'" >> /etc/environment

  That's only 4 bytes = 32 bits = ~4 billion possibilities. Sounds like a lot, but modern computers eat that for breakfast.

  Bug #2: Classic IDOR

  In the share endpoint:

  secret = db.query(Secret).filter(Secret.id == secret_id).first()  # Uh oh...

  Notice anything missing? There's no check that YOU actually own the secret! You can share anyone's secret, including the admin's flag.

  The Attack Plan

  Here's where it gets fun. The attack chains together beautifully:

  Step 1: Crack the Seed

  When you create a secret, it gets a random ID generated by the PRNG. I registered an account, created a test secret, and noted its ID: 3512353279794587034.

  Then I wrote a parallel brute-forcer to find which seed produces that ID. After a few minutes:

  [+] FOUND SEED: 4105293030
  [+] Admin's flag secret ID: 1883621791600913937

  Now I know:
  - The PRNG seed
  - The admin's secret ID (so I can use IDOR on it)

  Step 2: Predict the Admin Password

  Here's the clever bit. Looking at the admin bootstrap script:

  # Admin registers, creates flag secret, then...
  new_password = generate_password()  # Uses the PRNG!
  change_password(PASSWORD, new_password)

  The admin's password is generated by the same predictable PRNG! Since I cracked the seed, I can calculate exactly what password the admin has:

  admin_password = "VGzfzvSRYsz_yEgcwP4-FYVbLWrSEFMB"

  Step 3: The 2FA Problem

  Plot twist - admin has 2FA enabled! The login flow requires:
  1. Email + Password
  2. A valid TOTP code from their authenticator

  But wait... the admin's 2FA secret IS the flag (base32 encoded). I don't know the flag yet, so I can't generate valid codes... or can I?

  Step 4: IDOR to the Rescue

  Remember that IDOR bug? I can:
  1. Login as my regular user
  2. Create a share link to the admin's secret (ID 1883621791600913937)
  3. Visit the share link and see the current TOTP code!

  [+] Created share link: http://[instance]/share?token=mXEpEe5Wbei8Q7cqY1JowUP8BjVF0NMKS6TVax8yJAM
  [+] Got TOTP code from IDOR: 792761

  Step 5: Profit

  Now I have everything:
  - Admin email: admin@istra.tor
  - Admin password: VGzfzvSRYsz_yEgcwP4-FYVbLWrSEFMB
  - Current 2FA code: 792761

  Login, hit /export, and:

  {
    "secrets": [{
      "name": "Flag OTP",
      "secret_key": "M5RXIZT3KNKHEM26NVPSI2DVMZTDCZK7JUZXEZZTL4SHA7BRMMZV64RRNY2TGXZUNZSC2URTOAZTI5D5"
    }]
  }

  Base32 decode that secret key and...

  ðŸš© Flag

  gctf{STr3^m_$huff1e_M3rg3_$p|1c3_r1n53_4nd-R3p34t}

  Lessons Learned

  1. Never roll your own crypto/randomness - Use battle-tested libraries like secrets
  2. Always verify authorization - Just because someone knows an ID doesn't mean they should access it
  3. Small seeds = big problems - 32 bits of entropy is crackable in minutes
  4. Defense in depth matters - Any single bug here wouldn't be catastrophic, but chained together? Game over.

  The challenge name "Secret Sharing Platform" is deliciously ironic - turns out it was sharing secrets a bit too freely! ðŸ˜„
